<link rel="stylesheet" href="{{ url_for('static', filename='css/styles.css') }}">

<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <title>Setting - Users</title>
</head>

<body>
    <nav>
        <div class="logo">üé¨ NIDA Movies</div>
        <div class="menu">
            <a href="/home">Home</a>
            <a href="/dashboard">Dashboard</a>
            <div class="dropdown">
                <a href="#" class="dropbtn">Setting ‚ñæ</a>
                <div class="dropdown-content">
                    <a href="/setting/movie">Setting Movie</a>
                    <a href="/setting/user">Setting User</a>
                </div>
            </div>
            <a href="/login">Logout</a>
        </div>
    </nav>

    <div class="user-container">
        <h1>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ (Setting User)</h1>
        <div class="add-btn-container">
            <button class="add-btn" onclick="openAddModal()">+ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ</button>
        </div>        
        <table>
            <thead>
                <tr>
                    <th>#</th>
                    <th>‡∏ä‡∏∑‡πà‡∏≠</th>
                    <th>‡∏≠‡∏µ‡πÄ‡∏°‡∏•</th>
                    <th>Action</th>
                </tr>
            </thead>
            <tbody id="user-table">
            </tbody>
        </table>
        <div class="pagination">
            <button id="prevBtn">¬´ ‡∏Å‡πà‡∏≠‡∏ô‡∏´‡∏ô‡πâ‡∏≤</button>
            <span id="pageInfo">‡∏´‡∏ô‡πâ‡∏≤ 1</span>
            <button id="nextBtn">‡∏ñ‡∏±‡∏î‡πÑ‡∏õ ¬ª</button>
        </div>
    </div>



</body>
<!-- Modal ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç -->
<div id="editModal" class="modal">
    <div class="modal-content">
        <span class="close-btn" onclick="closeModal()">&times;</span>
        <h2>‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ</h2>
        <form id="editForm">
            <label>‡∏ä‡∏∑‡πà‡∏≠:</label><br>
            <input type="text" id="editName" required><br><br>
            <label>‡∏≠‡∏µ‡πÄ‡∏°‡∏•:</label><br>
            <input type="email" id="editEmail" required><br><br>
            <button type="submit">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
        </form>
    </div>
</div>
<div id="addModal" class="modal">
    <div class="modal-content">
        <span class="close-btn" onclick="closeAddModal()">&times;</span>
        <h2>‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÉ‡∏´‡∏°‡πà</h2>
        <form id="addForm">
            <label>‡∏ä‡∏∑‡πà‡∏≠:</label><br>
            <input type="text" id="addName" required><br><br>
            <label>‡∏≠‡∏µ‡πÄ‡∏°‡∏•:</label><br>
            <input type="email" id="addEmail" required><br><br>
            <label>‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô:</label><br>
            <input type="password" id="addPassword" required><br><br>
            <button type="submit">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ</button>
        </form>
    </div>
</div>

<script>
    let editingEmail = null;
    let currentPage = 1;
    const limit = 5;

    function loadUsers(page) {
        fetch(`/api/users?page=${page}&limit=${limit}`)
            .then(res => res.json())
            .then(result => {
                const users = result.users;
                const totalPages = result.totalPages;

                const table = document.getElementById('user-table');
                table.innerHTML = ""; // ‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå‡∏Å‡πà‡∏≠‡∏ô

                users.forEach((user, index) => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${(page - 1) * limit + index + 1}</td>
                        <td>${user.name || '-'}</td>
                        <td class="table-email">${user.email || '-'}</td>
                        <td>
                            <button onclick="editUser('${user.email}')">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button>
                            <button onclick="deleteUser('${user.email}')">‡∏•‡∏ö</button>
                        </td>
                        `;
                    table.appendChild(row);
                });

                // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï page info
                document.getElementById("pageInfo").textContent = `‡∏´‡∏ô‡πâ‡∏≤ ${page} / ${totalPages}`;

                // ‡∏õ‡∏¥‡∏î/‡πÄ‡∏õ‡∏¥‡∏î‡∏õ‡∏∏‡πà‡∏°
                document.getElementById("prevBtn").disabled = (page === 1);
                document.getElementById("nextBtn").disabled = (page === totalPages);

                currentPage = page;
            })
            .catch(err => {
                console.error("Error loading users:", err);
                const table = document.getElementById('user-table');
                table.innerHTML = `<tr><td colspan="3">‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</td></tr>`;
            });
    }

    function editUser(email) {
        alert(`Edit user: ${email}`);
    }

    function deleteUser(email) {
        if (confirm(`‡∏Ñ‡∏∏‡∏ì‡πÅ‡∏ô‡πà‡πÉ‡∏à‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà‡∏ß‡πà‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö ${email} ?`)) {
            fetch(`/api/users/${encodeURIComponent(email)}`, {
                method: 'DELETE'
            })
                .then(res => {
                    if (res.ok) {
                        alert("‡∏•‡∏ö‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à");
                        loadUsers(currentPage);
                    } else {
                        alert("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö");
                    }
                });
        }
    }

    function openAddModal() {
        document.getElementById('addModal').style.display = 'block';
    }
    function closeAddModal() {
        document.getElementById('addModal').style.display = 'none';
    }

    document.getElementById('addForm').addEventListener('submit', function (e) {
        e.preventDefault();

        const newUser = {
            name: document.getElementById('addName').value,
            email: document.getElementById('addEmail').value,
            password: document.getElementById('addPassword').value
        };

        fetch(`/api/users`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(newUser)
        })
            .then(res => {
                if (res.ok) {
                    alert("‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à");
                    closeAddModal();
                    loadUsers(currentPage);
                    document.getElementById('addForm').reset();
                } else {
                    alert("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ");
                }
            });
    });

    function editUser(email) {
        fetch(`/api/users/${encodeURIComponent(email)}`)
            .then(res => res.json())
            .then(user => {
                editingEmail = user.email;
                document.getElementById('editName').value = user.name;
                document.getElementById('editEmail').value = user.email;
                document.getElementById('editModal').style.display = 'block';
            });
    }

    function closeModal() {
        document.getElementById('editModal').style.display = 'none';
        editingEmail = null;
    }
    document.getElementById('editForm').addEventListener('submit', function (e) {
        e.preventDefault();

        const updatedUser = {
            name: document.getElementById('editName').value,
            email: document.getElementById('editEmail').value
        };

        fetch(`/api/users/${encodeURIComponent(editingEmail)}`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(updatedUser)
        })
            .then(res => {
                if (res.ok) {
                    alert("‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à");
                    closeModal();
                    loadUsers(currentPage);
                } else {
                    alert("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å");
                }
            });
    });

    document.getElementById("prevBtn").addEventListener("click", () => loadUsers(currentPage - 1));
    document.getElementById("nextBtn").addEventListener("click", () => loadUsers(currentPage + 1));

    loadUsers(1);


</script>

</html>